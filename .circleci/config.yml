version: 2.1


parameters:
  manifest: # Minimal manifest URL: AOSP or OMNI
    type: string
    default: "https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp"
  manifest_branch: # Minimal manifest branch: twrp-12.1 and below
    type: string
    default: "twrp-12.1"
  device_tree: # Device tree URL
    type: string
    default: "https://github.com/cd-Crypton/custom_recovery_tree_realme_nashc"
  device_branch: # Device tree branch
    type: string
    default: "android-staging"
  device_path: # Device path
    type: string
    default: "device/realme/nashc"
  device_makefile: # Device makefile: twrp or omni + _devicename
    type: string
    default: "twrp_nashc"
  build_target: # Build target: bootimage, recoveryimage, vendorbootimage
    type: string
    default: "recoveryimage"

jobs:
  recovery:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      MANIFEST: << pipeline.parameters.manifest >>
      MANIFEST_BRANCH: << pipeline.parameters.manifest_branch >>
      DEVICE_TREE: << pipeline.parameters.device_tree >>
      DEVICE_BRANCH: << pipeline.parameters.device_branch >>
      DEVICE_PATH: << pipeline.parameters.device_path >>
      DEVICE_MAKEFILE: << pipeline.parameters.device_makefile >>
      BUILD_TARGET: << pipeline.parameters.build_target >>
    steps:
      - checkout
      - when:
          condition:
            equal: [ test, << pipeline.git.branch >> ]
          steps:
            - run:
                name: Cleanup
                command: |
                  git clone https://github.com/carlodandan/slimhub_actions
                  sudo chmod a+x slimhub_actions/cleanup.sh && sudo bash slimhub_actions/cleanup.sh
                
            - run:
                name: Swap File
                command: |
                  free -h
                  export SWAP_FILE=/swapfile
                  sudo fallocate -l 16G $SWAP_FILE
                  sudo chmod 600 $SWAP_FILE
                  sudo mkswap $SWAP_FILE
                  sudo swapon $SWAP_FILE
                  free -h
                
            - run:
                name: Build Environment
                command: |
                  export DEBIAN_FRONTEND=noninteractive
                  sudo apt update
                  sudo apt -y upgrade
                  sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libtinfo5 libgflags-dev python3 python-is-python3
                  
            - run:
                name: Use PyEnv for Python3 # This is to avoid syntax error in git-repo tool when syncing manifest
                command: |
                  pyenv global $(python3 --version | awk '{print $2}')
                  
            - run:
                name: Install Git-Repo
                command: |
                  mkdir -p ~/bin
                  curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
                  chmod a+x ~/bin/repo
                  sudo ln -sf ~/bin/repo /usr/bin/repo
        
            - run: 
                name: Sync Manifest
                command: |
                  mkdir -p ~/android/recovery && cd ~/android/recovery
                  git config --global user.name "Carlo Dandan"
                  git config --global user.email "carlodandan.personal@proton.me"
                  repo init --depth=1 -u $MANIFEST -b $MANIFEST_BRANCH
                  repo sync -j$(nproc --all) --force-sync
    
            - run:
                name: Device Tree
                command: |
                   cd ~/android/recovery
                   git clone --depth=1 $DEVICE_TREE -b $DEVICE_BRANCH $DEVICE_PATH
    
            - run:
                name: Build Recovery
                command: |
                   cd ~/android/recovery
                   source build/envsetup.sh
                   export ALLOW_MISSING_DEPENDENCIES=true
                   lunch $DEVICE_MAKEFILE-eng && make $BUILD_TARGET

            - store_artifacts:
                path: ~/android/recovery/out/target/product/nashc/recovery.img
                destination: TWRPIMAGE
             
workflows:
  build:
    jobs:
      - recovery
